<!DOCTYPE html>
<html>
  <head>
    <title>Conflicts?</title>
  </head>
  <body>

  <h2 style="font-family: Arial, sans-serif;">Drug/Allergy Conflicts?</h2>
  <ui id="TheAnswer" style="font-weight: bold; font-size: 60pt; font-family: Arial, sans-serif; text-decoration: none; color: black;">
  	...
  </ui> 
  
	
	<script  src='../smart/scripts/smart-api-client.js'></script>
	<script>
		SMART = new SMART_CLIENT(null, window.top);
		
		SMART.send_ready_message(function(record_info) {
		
			// Keep track of the data we've obtained.	
			var got = {combined: $.rdf()};
			
			// Get and store a set of medications
			SMART.MEDS_get(function(r) {
				$.each(r.databank.triples(), function(){got.combined.databank.add(this);});
				got.meds = true;
				check_done();
			});
			
			// Get and store a set of allergies
			SMART.ALLERGIES_get(function(r) {
				$.each(r.databank.triples(), function(){got.combined.databank.add(this);});
				got.allergies = true;
				check_done();
			});
			
			
			var check_done = function() {
						
				// Wait until both meds + allergies have arrived (asynchronously)
				if (!(got.meds && got.allergies)) return;

				// Combined them into a single RDF graph, and serialize it
				var serialized = $.rdf.dump(got.combined.databank.triples(), 
    										 {format:'application/rdf+xml', 
											  serialize: true});
	
				
				// Run this graph through the 'check_allergies' webhook
				SMART.webhook_post("check_allergies", serialized, function(rdf) {

					var ta = $("#TheAnswer");
					ta.html("");
				
					// And examine the result for any drug/allergy conflicts,
					// displaying each to the user
					rdf.where("?s sp:conflict ?c").each(function(){
						ta.append($("<li>"+this.c.value+"</li>"));						
					});
					
					// Phew!
					if (ta.html() === "") ta.html("None");
					
				});
			};
		});
	</script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <title>Pediatric Blood Pressure Percentiles</title>
      <style>
        body {font-family: sans-serif; margin: 0px;}
        .sbp {text-align: right; font-size: 1em; font-weight: bold;}
        .dbp {text-align: left; font-size: 1em; font-weight: bold;}
        .spct {text-align: right;  position: relative; font-weight: bold;}
        .dpct {text-align: left;  position: relative; font-weight: bold;}
        .slash {padding-left: .4em; padding-right: .4em; font-weight: narrow;}
	#result table {background: white; font-size: 3em; border-collapse: collapse; }
	#result table th {background: #dddddd; font-size: 30%; font-style: italic;}
        input[type='text'] {border: 1px solid black;}
      </style>
      <link href='http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.css' rel='stylesheet' type='text/css'/> 

      <script src='../smart/scripts/smart-api-page.js'></script>
      <script type="text/javascript" src="http://code.jquery.com/jquery-1.5.min.js"></script> 
      <script type="text/javascript" src="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.js"></script> 
      <script src='./data/cdc_height_tables.js'></script>
      <script src='./data/nih_bp_tables.js'></script>
      <script src='./util.js'></script>
      <script src='./date.js'></script>

      <script>
        var p = { };
        var vitals = [];

        function sortByDate(a,b) {
			      var x = a.date;
			      var y = b.date;
			      return ( (x<y) ? 1: ((x>y)?-1:0));
        };

      $(document).ready(function() {$("#add_age").focus();});


	var loader = new StateCheck(['demographics', 'vitals']).onDone(function() {
	  
          for (var i = 0; i< vitals.length; i++) {
            v = vitals[i];
            var age = years_apart(v.vital_date.value, p.birthday.value);
			     
            var bpparams = {age: age, sex: p.gender.value, height: v.height.value, systolic: v.systolic.value, diastolic: v.diastolic.value};

	    if (i == vitals.length-1) {
	    $('#add_age').val(Math.round(bpparams.age));
	    $('#add_age_months').val(Math.round(12 * (bpparams.age - Math.round(bpparams.age))));
	    $('#add_height').val(Math.round(bpparams.height*100));
	    $('#add_diastolic').val(Math.round(bpparams.diastolic));
	    $('#add_systolic').val(Math.round(bpparams.systolic));
            if (bpparams.sex =='female')
                  $('#add_female').attr("checked", true);
            else 
                  $('#add_male').attr("checked", true);
            }

            var percentiles = bp_percentiles(bpparams);

          }

	});
        SMART.DEMOGRAPHICS_get(function(demos) {
          $.extend(p, demos.prefix('foaf', 'http://xmlns.com/foaf/0.1/')
                           .prefix('sp', 'http://smartplatforms.org/terms#')
                           .where('?a foaf:givenName ?givenName')
                           .where('?a foaf:familyName ?familyName')
                           .where('?a foaf:gender ?gender')
                           .where('?a sp:birthday ?birthday')
                           .get(0));
	    loader.done('demographics');
	});
	  
        SMART.VITAL_SIGNS_get(function(vital_signs){
          vital_signs.where('?v dc:date ?vital_date')
                           .where('?v sp:height ?h_vu')
                           .where('?h_vu sp:value ?height')
                           .where('?v sp:bloodPressure ?bp')
                           .where('?bp sp:systolic ?sys_vu')
                           .where('?bp sp:diastolic ?dias_vu')
                           .where('?sys_vu sp:value ?systolic')
                           .where('?dias_vu sp:value ?diastolic')
                           .each(function(){vitals.push(this)});

          loader.done('vitals');
        });


$("form input").live('change', function(){$("form").submit();});

$("form").live('submit', function(event){
			     event.stopPropagation();

	    var height = $('#add_height').val()/100.0;

            var bpparams = {age: parseInt($('#add_age').val()) + 1.0/12 * parseInt($('#add_age_months').val()) , 
			     sex: $('input[@name=add_gender]:checked').val(), 

			     height: height, 
			     systolic: $('#add_systolic').val(), 
			     diastolic: $('#add_diastolic').val()};
       
	    var percentiles = bp_percentiles(bpparams);

            var to_display = {systolic_mmhg: $('#add_systolic').val(),
			            diastolic_mmhg: $('#add_diastolic').val(),
			            systolic_percentile: percentiles.systolic,
			            diastolic_percentile: percentiles.diastolic,
			            date: new Date(),
                                    height: height,
                                    age: $('#add_age').val() + "y "+$('#add_age_months').val()+"m"
			      };   

	   $("#result .sbp").text(to_display.systolic_mmhg);
	   $("#result .dbp").text(to_display.diastolic_mmhg);
	   $("#result .spct").text(to_display.systolic_percentile);
	   $("#result .dpct").text(to_display.diastolic_percentile);

});

    </script>
  </head>
  <body >

<div data-role="page"> 

 
  <div data-role="content"> 

    <div id='errors' style='display: none; width: 600px; margin: 100px auto;'></div>
    <br>
    
    <div id='result'>
      <table>
	<tr><th>Systolic</th><th></th><th>Diastolic</th></tr>
	<tr>
	  <td><span class="spct"></span>%</td>
	  <td><span class="slash">/</span></td>
	  <td><span class="dpct"></span>%</td>
	</tr>
      </table>
    </div>

    <br clear="both"/>
    <table id='bp_table'>
    </table>
<form>

  <div data-role="fieldcontain"> 
    <label for="add_age">Age (years)</label> 
    <input type="range" name="name" id="add_age" value="4" min="0" max="18" /> 
  </div> 

  <div data-role="fieldcontain"> 
    <label for="add_age_months"> + Age (months)</label> 
    <input type="range" name="name" id="add_age_months" value="0" min="0" max="11" /> 
  </div> 
 
  <div data-role="fieldcontain"> 
    <fieldset data-role="controlgroup" data-type="horizontal"> 
      <legend>Gender</legend> 
      <input type="radio" name="add_gender" id="add_male" value="male" checked="checked" /> 
      <label for="add_male">Male</label> 

      <input type="radio" name="add_gender" id="add_female" value="female" /> 
      <label for="add_female">Female</label> 
    </fieldset> 
  </div> 

  <div data-role="fieldcontain"> 
    <label for="add_height">Height (cm)</label> 
    <input type="range" name="add_height" id="add_height" value="104" min="0" max="200"  /> 
  </div>


  <div data-role="fieldcontain"> 
    <label for="add_systolic">Systolic BP (mmHg)</label> 
    <input type="range" name="add_systolic" id="add_systolic" value="95" min="0" max="200"  /> 
  </div>

  <div data-role="fieldcontain"> 
    <label for="add_diastolic">Diastolic BP (mmHg)</label> 
    <input type="range" name="add_diastolic" id="add_diastolic" value="62" min="0" max="200"  /> 
  </div>
</form>
  </div><!-- /content --> 
</div><!-- /page --> 
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <title>Pediatric Blood Pressure Percentiles</title>
      <style>
        body {font-family: Arimo, sans-serif; margin: 0px;}
        .sbp {text-align: right; font-size: 1em; font-weight: bold; padding-left: 2em;}
        .dbp {text-align: left; font-size: 1em; font-weight: bold;}
        .spct {text-align: right; font-size: 70%; position: relative; top: -5px;}
        .dpct {text-align: left; font-size: 70%; position: relative; top: -5px;}
        .slash {font-size: 2em;}
        input[type='text'] {border: 1px solid black;}
      </style>
      <link href='http://fonts.googleapis.com/css?family=Arimo:regular,bold' rel='stylesheet' type='text/css'>
      <link href='http://fonts.googleapis.com/css?family=Kranky' rel='stylesheet' type='text/css'>

      <script src='../smart/scripts/smart-api-page.js'></script>
      <script src='../jquery/jquery.js'></script>
      <script src='./data/cdc_height_tables.js'></script>
      <script src='./data/nih_bp_tables.js'></script>
      <script src='./raphael.js'></script>
      <script src='./g.raphael.js'></script>
      <script src='./util.js'></script>
      <script src='./date.js'></script>
      <script>

        var p = { };
        var vitals = [];
	
	var initialize_chart = function(elt) {
	  elt.data("bps", []);
          elt.data("bpscale", 1.0);
	  var w = Math.min($(window).width(), $(".values", elt).width()),
              h = $(".values", elt).height()-25;
	  console.log("elt: " + $(".values", elt).width()+": " + $(".values", elt).height());
	  console.log(w+","+h);
	  var paper = Raphael($(".values", elt).get(0), w,h);
	  $(".values", elt).data("paper", paper);

	  var scale_elt = $(".scale_left", elt);
	  w = scale_elt.width();
	  paper = Raphael(scale_elt.get(0),w,h);
	  scale_elt.data("paper", paper);
          console.log("Scale left: " + scale_elt.length +","+w);


	  scale_elt = $(".scale_right", elt);
	  w = scale_elt.width();
          console.log("Scale right: " + scale_elt.length + ","+w);
	  paper = Raphael(scale_elt.get(0),w,h);
	  scale_elt.data("paper", paper);

	  draw_axes(elt);
	};
        
	var draw_axes = function(elt){
	  var paper = $(".values", elt).data("paper"),
	      slpaper = $(".scale_left", elt).data("paper"),
	      srpaper = $(".scale_right", elt).data("paper");

	  w = paper.width, 
          h = paper.height;
          paper.clear();
          var axis_elements = paper.set();
          paper.axis_elements = axis_elements;

  	  axis_elements.push(paper.rect(0,0,w,h, 0,0).attr({fill: "white", opacity: "1", stroke: "none"}));

          slpaper.clear();
  	  slpaper.rect(0,0,w,h, 30, 30).attr({fill: "white", opacity: ".8", stroke: "none"});

          srpaper.clear();
  	  srpaper.rect(-30,0,srpaper.width*2,h, 30, 30).attr({fill: "white", opacity: ".8", stroke: "none"});

	  var bptics = [];
	  var ntics = 8;
	  var mintic = 0;
	  var maxtic = 160;

	  var ticstart = 30;
	  var ticspan = (h-40 - ticstart) / (ntics+1);

	  elt.data("ticks", {start: ticstart, span: ticspan, min: mintic, max: maxtic, n: ntics});
          var tictxtattr = {font: "12px sans-serif", opacity: .8, "text-anchor": "end"};
          var ticattr = {stroke: "#208fc9", opacity: .2, "stroke-width": 1.2};
	  for (var i = 0; i < ntics+1; i++) {
	      var ticy = ticstart+ticspan*ntics-(i*ticspan);
	      var ticx = 0;
	      axis_elements.push(paper.path("M"+ticx+" "+ticy+"L"+w+" "+ticy).attr(ticattr));

	      slpaper.text(30, ticy, mintic+i*((maxtic-mintic)/ntics)).attr(tictxtattr),
	      slpaper.path("M"+ticx+" "+ticy+"L"+w+" "+ticy).attr(ticattr)

	      srpaper.text(0, ticy, mintic+i*((maxtic-mintic)/ntics)).attr(tictxtattr).attr({"text-anchor": "start"}),
	      srpaper.path("M"+ticx+" "+ticy+"L"+w+" "+ticy).attr(ticattr)
	  }
	};

	var draw_bp = function(elt, p, entrysize) {
		var sbp = p.systolic_mmhg,
	            dbp = p.diastolic_mmhg,
                    date = p.date,
                    spct = p.systolic_percentile,
                    dpct = p.diastolic_percentile,
	            date = p.date,
                    paper = $(".values", elt).data("paper"),
                    bpscale = elt.data("bpscale");
			      
	  var s = paper.set();

          var ticks = elt.data("ticks");
          function bpcoord(bp) {
            return ticks.start + ticks.span*ticks.n - (bp-ticks.min) * ticks.n*ticks.span/(ticks.max-ticks.min);
          };
          
          var sysattr = {font: 25*bpscale+"px 'Arimo:bold', sans-serif", "text-anchor": "end", opacity: .9, fill: "#cd00b9", stroke: "none"};
          var diasattr = {font: 25*bpscale+"px 'Arimo:bold', sans-serif", "text-anchor": "start", opacity: .9, fill: "#6d8cb1", stroke: "none"};
          var slashattr = {font: 30*bpscale+"px 'Arimo', sans-serif", "text-anchor": "middle", opacity: .8, fill: "#555555", stroke: "#555555"};
          var dateattr = {font: 12*bpscale+"px 'Arimo'", "text-anchor": "middle", opacity: .8, fill: "#555555", stroke: "none"};
          var insetattr = {font: 16*bpscale+"px 'Arimo'", "text-anchor": "middle", opacity: 1, fill: "white"};
			
          var pad = 75;
	  var datetext = paper.text(0, paper.height-10,date.toString("M/d/yyyy HH:mm")).attr(dateattr);
  	  s.push(datetext);	      


	  var sbptxt = paper.text(-5, paper.height-45,sbp).attr(sysattr);
	  s.push(sbptxt);
	  var slash = paper.text(0, paper.height-45,"/").attr(slashattr);
	  s.push(slash);
          var dbptxt = paper.text(5, paper.height-45, dbp).attr(diasattr);
	  s.push(dbptxt);

	  var pctattr = {font: 15*bpscale+"px 'Arimo:bold', sans-serif"};
			      
	  var sbppcttxt = paper.text(0, sbptxt.attrs.y+20,spct+"%").attr(sysattr).attr(pctattr);
	  s.push(sbppcttxt);
	  var dbppcttxt = paper.text(5, dbptxt.attrs.y+20,dpct+"%").attr(diasattr).attr(pctattr);
	  s.push(dbppcttxt);

          var shrink_factor = 250/80.0 /  bpscale ;
	  s.push(paper.path("M0 "+bpcoord(sbp)+" L0 "+bpcoord(dbp)).attr(slashattr).attr({"stroke-width": 5 * bpscale}));

          s.push(paper.circle(0,bpcoord(sbp), spct/shrink_factor).attr(sysattr).attr({opacity: 1}));
          s.push(paper.circle(0,bpcoord(dbp), dpct/shrink_factor).attr(diasattr).attr({opacity: 1}));

          var sspecial_text = "";
          var sspecial_color = "orange";
          var special_radius = 65 / shrink_factor;
          if (spct >= 90) {
              sspecial_text = "90+";
          }
          if (spct >= 95) {
              sspecial_text = "95+";
              sspecial_color = "red";
          }
          if (spct >= 99) {
              sspecial_text = "99+";
              sspecial_color = "black";
          }
          if (sspecial_text !== "") {
             s.push(paper.circle(0,bpcoord(sbp), special_radius).attr(sysattr).attr({fill: sspecial_color, opacity: 0.8}));
             s.push(paper.text(0, bpcoord(sbp),sspecial_text).attr(insetattr));
          }


          var dspecial_text = "";
          var dspecial_color = "orange";
          if (dpct >= 90) {
              dspecial_text = "90+";
          }
          if (dpct >= 95) {
              dspecial_text = "95+";
              dspecial_color = "red";
          }
          if (dpct >= 99) {
              dspecial_text = "99+";
              dspecial_color = "black";
          }

          if (dspecial_text !== "") {
             s.push(paper.circle(0,bpcoord(dbp), special_radius).attr(sysattr).attr({fill: dspecial_color, opacity: 0.8}));
             s.push(paper.text(0, bpcoord(dbp),dspecial_text).attr(insetattr));
          }

          return s;
        };

        var add_bp = function(elt, p) {		
                elt.data("bps").push(p);
        };

        function sortByDate(a,b) {
			      var x = a.date;
			      var y = b.date;
			      return ( (x<y) ? 1: ((x>y)?-1:0));
        };

        var draw_bps = function(elt) {
          var bps = elt.data("bps");
          if (bps === undefined) return;
	  bps.sort(sortByDate);
          var paper = $(".values", elt).data("paper");
          var bpscale = elt.data("bpscale");

          var entrysize = 100 * bpscale;
	  var offset = entrysize/2.0;

          var avail_w    = $(window).width()-60,
              required_w = offset+entrysize*bps.length;
          var w = Math.min(required_w, avail_w);

          paper.setSize(required_w, paper.height);
	  $(".values", elt).width(w);
          draw_axes(elt);


            var onestep = function(j, max) {
              return function() {
                for (var i = j; i < max; i++)  {
     	           var s = draw_bp(elt, bps[i], entrysize);
                   s.translate(offset + entrysize*(bps.length-1) - entrysize*i, 0);
                }
		lasttime = new Date().getTime();

              };
            };
          elt.hide();
          var lasttime = new Date().getTime();
          for (var j = 0; j < bps.length; j+= 20)
          { 
            setTimeout(onestep(j,Math.min(j+20, bps.length)), 1);
          }
          setTimeout(function(){ 
			      elt.show();           
			      $(".values", elt).scrollLeft(99999);
                     });
        };


        var draw_most_recent_bp = function(elt) {
          var bps = elt.data("bps");
	  bps.sort(sortByDate);
          var paper = $(".values", elt).data("paper");
          var bpscale = elt.data("bpscale");
          var entrysize = 100 * bpscale;
	  var offset = entrysize/2.0;
          var avail_w    = $(window).width()-60,
              required_w = offset+entrysize*bps.length;
          var w = Math.min(required_w, avail_w);

          paper.setSize(required_w, paper.height);
          var more_axis = paper.axis_elements.clone();
          more_axis.translate(more_axis.getBBox().width);
          paper.axis_elements = more_axis;
	  $(".values", elt).width(w);
          $(".values", elt).scrollLeft(99999);
          console.log("drawing most recent");
          var s = draw_bp(elt, bps[0], entrysize);
          s.hide();
          s.animate({translation:[offset + entrysize*(bps.length-1), -paper.height]}, 0);
          s.show();
          s.animate({translation:[0, paper.height]}, 150);  
          console.log("drawn");
        };

      $(document).ready(function() {$("#add_age").focus();});

       $(window).resize(function(){
//            draw_bps($("#bp_graph"));
	});



	var loader = new StateCheck(['demographics', 'vitals']).onDone(function() {
	  initialize_chart($("#bp_graph"));
          return;

          for (var i = 0; i< vitals.length; i++) {
            v = vitals[i];
            var age = years_apart(v.vital_date.value, p.birthday.value);
			     
            var bpparams = {age: age, sex: p.gender.value, height: v.height.value, systolic: v.systolic.value, diastolic: v.diastolic.value};

	    $('#add_age').val(Math.round(bpparams.age));
	    $('#add_height').val(Math.round(bpparams.height*100));
	    $('#add_diastolic').val(Math.round(bpparams.diastolic));
	    $('#add_systolic').val(Math.round(bpparams.systolic));
            if (bpparams.sex =='female')
                  $('#add_female').attr("checked", true);
            else 
                  $('#add_male').attr("checked", true);


            var percentiles = bp_percentiles(bpparams);

            add_bp($("#bp_graph"), {systolic_mmhg: v.systolic.value,
			            diastolic_mmhg: v.diastolic.value,
			            systolic_percentile: percentiles.systolic,
			            diastolic_percentile: percentiles.diastolic,
			            date: parse_date(v.vital_date.value),
                                    height: v.height.value,
                                    age: age
			           });			     
          }
          draw_bps($("#bp_graph"));

	});

        SMART.DEMOGRAPHICS_get(function(demos) {
          $.extend(p, demos.prefix('foaf', 'http://xmlns.com/foaf/0.1/')
                           .prefix('sp', 'http://smartplatforms.org/terms#')
                           .where('?a foaf:givenName ?givenName')
                           .where('?a foaf:familyName ?familyName')
                           .where('?a foaf:gender ?gender')
                           .where('?a sp:birthday ?birthday')
                           .get(0));

	    loader.done('demographics');
	});
	  
        SMART.VITAL_SIGNS_get(function(vital_signs){

          vital_signs.where('?v dc:date ?vital_date')
                           .where('?v sp:height ?h_vu')
                           .where('?h_vu sp:value ?height')
                           .where('?v sp:bloodPressure ?bp')
                           .where('?bp sp:systolic ?sys_vu')
                           .where('?bp sp:diastolic ?dias_vu')
                           .where('?sys_vu sp:value ?systolic')
                           .where('?dias_vu sp:value ?diastolic')
                           .each(function(){vitals.push(this)});

          loader.done('vitals');
        });

$("#zoom_in").live('click', function(){
  var oldz =   $("#bp_graph").data("bpscale");
  oldz *= 1.5;
  oldz = Math.min(oldz, 1.0);
  $("#bp_graph").data("bpscale", oldz);
  draw_bps($("#bp_graph"));
});

$("#zoom_out").live('click', function(){
  var oldz =   $("#bp_graph").data("bpscale");
  oldz /= 1.5;
  oldz = Math.max(oldz, .01);
  $("#bp_graph").data("bpscale", oldz);
  draw_bps($("#bp_graph"));
});


$("#add_submit").live('click', function(event){
			     event.stopPropagation();

	    var height = $('#add_height').val()/100.0;
            var bpparams = {age: $('#add_age').val(), sex: $('input[@name=add_gender]:checked').val(), height: height, systolic: $('#add_systolic').val(), diastolic: $('#add_diastolic').val()};
            var percentiles = bp_percentiles(bpparams);

            add_bp($("#bp_graph"), {systolic_mmhg: $('#add_systolic').val(),
			            diastolic_mmhg: $('#add_diastolic').val(),
			            systolic_percentile: percentiles.systolic,
			            diastolic_percentile: percentiles.diastolic,
			            date: new Date(),
                                    height: height,
                                    age: $('#add_age').val()
			           });			     
            draw_most_recent_bp($("#bp_graph"));


  return false;
});

    </script>
  </head>
  <body >
    <div id='errors' style='display: none; width: 600px; margin: 100px auto;'></div>

    <div id='bp_graph' >
      <div class='scale_left' style='width: 30px;  float: left;'></div>
      <div class='values' style='height: 400px; width: 150px; overflow-x: auto; float: left'></div>
      <div class='scale_right' style='width: 30px;  float: left;'></div>
    </div>
<!--
   <br clear="both"/>
   <div> <a id="zoom_in" href="#">+</a> <a id="zoom_out" href="#">-</a></div>
    <input type='text' id='scale' value=1>

-->
    <br clear="both"/>
    <table id='bp_table'>
    </table>
<form>
      <table>
<tr><td>
      Age (y): </td><td><input type='text' id='add_age' size='2' value='4'/></td></tr>
	<tr><td colspan='2'>Male<input id='add_male' style='margin-right: 1em' type="radio" name="add_gender" value="male" checked="checked" /> Female <input id='add_female' type="radio" name="add_gender" value="female"  /></td></tr>
	<tr><td> Height (cm):</td><td> <input type='text' id='add_height' size='3' value='85'/></td></tr>
	<tr><td> Systolic (mmHg):</td><td> <input type='text' id='add_systolic' size='3' value='92'/></td></tr>
	<tr><td> Diastolic (mmHg):</td><td> <input type='text' id='add_diastolic' size='3' value='55'/></td></tr>
        <tr><td colspan='2'><input type='submit' id='add_submit' value='Plot another reading'></td></tr>
</table>
</form>
    <div id='log'></div>

  </body>
</html>

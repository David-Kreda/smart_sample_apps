<!DOCTYPE html>
<html>
  <!--
    Diabetes Mellitus Monograph SMART App
    =====================================

    From the SMART Project <http://www.smartplatforms.org/>
    Arjun Sanyal <arjun.sanyal@childrens.harvard.edu> - Design and Implementation

    Todo:
    - fill in requires in manifest file

  -->
  <head>
    <title>Diabetes Mellitus Monograph</title>
      <style>
        #errors {
          font-size: 16px;
          font-family: Calibri, "Helvetica Neue", Helvetica, Verdana, sans-serif;
          color: #555;
        }
      </style>
      <script src='../smart/scripts/smart-api-client.js'></script>
      <script src='./jquery-1.7.2.min.js'></script>
      <script>
        var pt = {};

        var error_callback = function(e){
          alert('error '+e.status+' see console.')
          console.log(e.status);
          console.log(e.message.contentType);
          console.log(e.message.data);
          dfd.reject(e.message);
        };

        // Data API Calls (in alphabetical order)
        var ALLERGIES_get = function(){
          return $.Deferred(function(dfd){
            SMART.ALLERGIES_get()
              .success(function(allergies){
                var no_known_allergies_p = allergies.graph
                  .prefix('dcterms','http://purl.org/dc/terms/')
                  .prefix('sp','http://smartplatforms.org/terms#')
                  .prefix('rdf', 'http://www.w3.org/1999/02/22-rdf-syntax-ns#')
                  .where('?allergy_id rdf:type sp:AllergyExclusion')
                  .where('?allergy_id sp:allergyExclusionName ?bn')
                  .where('?bn sp:code ?snomed_code_uri')
                  .where('?snomed_code_uri dcterms:identifier "1602440022"')
                  .length

                $.extend(pt, {'no_known_allergies_p': no_known_allergies_p})

                dfd.resolve();
              })
              .error(error_callback);
          }).promise();
        };

        var DEMOGRAPHICS_get = function(){
          return $.Deferred(function(dfd){
            SMART.DEMOGRAPHICS_get()
              .success(function(demos){
                $.extend(pt, demos.graph
                    .prefix('foaf', 'http://xmlns.com/foaf/0.1/')
                    .prefix('v', 'http://www.w3.org/2006/vcard/ns#')
                    .prefix('rdf', 'http://www.w3.org/1999/02/22-rdf-syntax-ns#')
                    .where('?r v:n ?n')
                    .where('?n rdf:type v:Name')
                    .where('?n v:given-name ?givenName')
                    .where('?n v:family-name ?familyName')
                    .where('?r foaf:gender ?gender')
                    .where('?r v:bday ?birthday')
                    .get(0))
                dfd.resolve();
              })
              .error(error_callback);
          }).promise();
        };

        

        var VITAL_SIGNS_get = function(){
          return $.Deferred(function(dfd){
            SMART.VITAL_SIGNS_get()
              .success(function(r){

                r.graph
                 .prefix('sp',       'http://smartplatforms.org/terms#')
                 .prefix('rdf',      'http://www.w3.org/1999/02/22-rdf-syntax-ns#')
                 .prefix('dcterms',  'http://purl.org/dc/terms/')
                 .where('?bn         rdf:type         sp:VitalSign')
                 .where('?bn         sp:vitalName     ?vital_name')
                 .where('?bn         sp:value         ?value')
                 .where('?bn         sp:unit          ?unit')
                 .where('?vital_name sp:code          <http://purl.bioontology.org/ontology/LNC/8462-4>')
                 .where('?bn2        sp:diastolic     ?bn')
                 .where('?bn2        rdf:type         sp:BloodPressure')
                 .where('?vital_id   sp:bloodPressure ?bn2')
                 .where('?vital_id   dcterms:date     ?date')
                 .each(function(){
                   console.log('diastolic blood pressure'
                             , this.value.value
                             , this.unit.value
                             , this.date.value)
                 })
                dfd.resolve();
              })
              .error(error_callback);
          }).promise();
        };
        
        SMART.ready(function() {
            $.when(ALLERGIES_get()
                 , DEMOGRAPHICS_get()
                 , VITAL_SIGNS_get()
                 // , MEDS_get()
                 // , NOTES_get()
                 // , PROBLEMS_get()
                 // , VITAL_SIGNS_get()
                 ).then(function() {
              console.log(pt.birthday.value
                        , pt.familyName.value
                        , pt.gender.value
                        , pt.givenName.value
                        , "no_known_allergies_p?"
                        , pt.no_known_allergies_p
                        )
            });
        });

    </script>
  </head>
  <body style="margin: none;">
    <div id='errors' style='display: none; margin: 100px auto;'></div>
    <div id='content'></div>
    <div id='log' style='display: none;'></div>
  </body>
</html>

<!DOCTYPE html>
<html>
  <!--
    Diabetes Mellitus Monograph SMART App
    =====================================

    From the SMART Project <http://www.smartplatforms.org/>
    Arjun Sanyal <arjun.sanyal@childrens.harvard.edu> - Design and Implementation

    Notes:
    - Designed for a 1280x1024 window size
    - Using a 960.gs fluid grid with col width = 60, no col = 9,
      and gutter width = 0 for 720px total

    TODO:
    - fill in requires in manifest file
  -->
  <head>
    <title>Diabetes Mellitus Monograph</title>
      <link rel='stylesheet' href='./assets/fluid_grid_60_12_0.css'>
      <style>
        #errors {
          font-size: 16px;
          font-family: Calibri, "Helvetica Neue", Helvetica, Verdana, sans-serif;
          color: #555;
        }

        body {
          background-color: white;
          font-family: Verdana, "Lucida Grande", "Helvetica Neue", Helvetica, Calibri, sans-serif;
          font-size: 12px !important;
          line-height: 1.5em;
        }

        .grid_1,
        .grid_2,
        .grid_3,
        .grid_4,
        .grid_5,
        .grid_6,
        .grid_7,
        .grid_8,
        .grid_9,
        .grid_10,
        .grid_11,
        .grid_12 {
          display:inline;
          float: left;
          position: relative;

          /* fixme: usually 1% each, but  */
          margin-left: 1% !important;
          margin-right: 1% !important;
        }

        .container_12 {
          /* usually width: 92% and both margins at 4% each */
          width: 99%;
          margin-left: 1% !important;
          margin-right: 0 !important;
        }

        .section_header {
          background-color: rgb(207, 201, 254);
          margin-bottom: 6px;
        }
        .bold { font-weight: bold; }

      </style>
      <!-- order: smart-api-client, xdate, data, flot, excanvas -->
      <script src='../smart/scripts/smart-api-client.js'></script>
      <script src='./js/xdate.js'></script>
      <script src='./js/data.js'></script>
      <script src='./js/flot/jquery.flot.min.js'></script>
      <script src='./js/flot/jquery.flot.resize.min.js'></script>
      <script src='./js/jsonld.js'></script>
      <!--[if lte IE 8]><script src="./js/flot/excanvas.min.js"></script><![endif]-->
      <script>
        // On SMART.ready, do all the data api calls and synchronize
        // when they are all complete.
        SMART.ready(function(){
          $.when(
                 ALLERGIES_get()
               , DEMOGRAPHICS_get()
               , VITAL_SIGNS_get()
               , LAB_RESULTS_get()
               // , MEDS_get()
               // , NOTES_get()
               // , PROBLEMS_get()
               // , VITAL_SIGNS_get()
          )
          .then(function(){

            $('#family_name').text(pt.family_name.value)
            $('#given_name').text(pt.given_name.value)
            $('#record_id').text(SMART.record.id)
            $('#birthday').text(pt.bday.value)
            var b = new XDate(pt.bday.value)
            $('#age').text(Math.round(b.diffYears(new XDate())));
            $('#gender').text(pt.gender.value[0])

            // testing flot
            var x_min = new XDate('2010').valueOf();
            var x_max = new XDate().valueOf()

            var flot_options_bp = {
              xaxis: {
                mode: 'time',
                timeformat: '%y',
                min: x_min,
                max: x_max,
                tickSize: [1, 'year'],
                minTickSize: [1, 'year']
                // tickLength: 0
              },
              yaxis: {
                min: 50,
                max: 200,
                ticks: [50, 100, 150, 200],
                tickLength: 0
              },
              series: {
                lines: {
                  show: false
                },
                points: {
                  show: true
                }
              },
              grid: {
                // dark gray rbg(204, 204, 204)  #cccccc
                // light gray rbg(235, 235, 235) #ebebeb
                // color: '#ebebeb',
                backgroundColor: '#ebebeb',
                borderWidth: 1,
                markings: [
                  { yaxis: { from: 80, to: 80 }, color: "#ccc" },
                  { yaxis: { from: 130, to: 130 }, color: "#ccc" }
                ]
              }
            }

            // alter the options for the other two graphs
            var flot_options_ldl = $.extend(true, {}, flot_options_bp);
            var flot_options_a1c = $.extend(true, {}, flot_options_bp);

            flot_options_ldl.yaxis = {
              min: 0,
              max: 200,
              ticks: [0, 50, 100, 150, 200],
              tickLength: 0
            }

            flot_options_ldl.grid = {
              backgroundColor: '#ebebeb',
              borderWidth: 1,
              markings: [
                { yaxis: { from: 200, to: 100 }, color: "#ccc" },
              ]
            }

            flot_options_a1c.yaxis = {
              min: 0,
              max: 20,
              ticks: [0, 5, 10, 15, 20],
              tickLength: 0
            }

            flot_options_a1c.grid = {
              backgroundColor: '#ebebeb',
              borderWidth: 1,
              markings: [
                { yaxis: { from: 20, to: 7 }, color: "#ccc" },
              ]
            }

            var dbp_array = [];
            var sbp_array = [];
            var ldl_array = [];
            var a1c_array = [];

            $.each(pt.dbp_array, function(i,v){
              var d = new XDate(v.date);
              dbp_array.push([d.valueOf(), Number(v.value)]);
            });

            $.each(pt.sbp_array, function(i,v){
              var d = new XDate(v.date);
              sbp_array.push([d.valueOf(), Number(v.value)]);
            });

            ldl_array = sbp_array;

            $.each(sbp_array, function(i,v){
              a1c_array.push(
                [sbp_array[i][0],
                 sbp_array[i][1]/10
                ]
              );
            })

            // set the heights for the graphs and set the width
            // of the a1c graph to be the same as the other graphs
            // var w = $('#column_1').width();
            var h = 100;
            $('#bp_graph').height(h);
            $('#ldl_graph').height(h);
            $('#a1c_graph').height(h).width($('#bp_graph').width());

            var plot = $.plot($("#bp_graph"),
                   [dbp_array, sbp_array],
                   flot_options_bp
            );

            var plot = $.plot($("#ldl_graph"),
                   [ldl_array],
                   flot_options_ldl
            );

            var plot = $.plot($("#a1c_graph"),
                   [a1c_array],
                   flot_options_a1c
            );
          });
        });
      </script>
  </head>
  <body style="margin: 0px;">
    <div id='content' class="container_12">
      <div id='top_line' class='grid_12' style='padding-left: 2em; font-weight: bold'>
        <span style='text-transform: uppercase'>
          <span id='family_name'></span>,
          <span id='given_name'></span>
          &nbsp;
          <span id='record_id'></span>
          &nbsp;
          <span id='birthday'></span>
          &nbsp;
          (<span id='age'></span> <span style='text-transform: lowercase'>YRS.</span>)
          &nbsp;
          <span id='gender'></span>
          </span>
      </div>

      <div class='clear'></div>

      <div id='column_1' class='grid_3' style='border: none; height: 1000px;'>
        <div class='section_header'>
          <span class='bold'>BP</span> goal &lt; 130/80
        </div>

        <div id='bp_graph' style='padding-top: 6px;'></div>

        <div id='last_known_values' style='padding-top: 2em;'>
          <div class='section_header'><span class='bold'>Last Known Values</span></div>
        </div>
      </div>

      <div id='column_2' class='grid_3' style='border: none; height: 1000px;'>
        <div class='section_header'><span class='bold'>LDL</span> goal &lt; 100</div>

        <div id='ldl_graph' style='padding-top: 6px;'></div>

        <div id='other_info' style='padding-top: 2em;'>
          <div class='section_header'><span class='bold'>Other Info</span></div>
        </div>

        <div id='major_cv_comorbidities' style='padding-top: 2em;'>
          <div class='section_header'><span class='bold'>Major CV Comorbidities</span></div>
        </div>

        <div id='other_problems' style='padding-top: 2em;'>
          <div class='section_header'><span class='bold'>Other Problems</span></div>
        </div>
      </div>

      <div id='column_3' class='grid_6'  style='border: none; height: 1000px;'>
        <div class='section_header'><span class='bold'>A1C</span> goal &lt; 7</div>

        <div id='a1c_graph' style='padding-top: 6px;'></div>

        <div id='reminders' style='padding-top: 2em;'>
          <div class='section_header'><span class='bold'>Reminders</span></div>
          TODO
        </div>

        <div id='allergies' style='padding-top: 2em;'>
          <div class='section_header'><span class='bold'>Allergies</span></div>
        </div>

        <div id='medications' style='padding-top: 2em;'>
          <div class='section_header'><span class='bold'>Medications</span></div>
        </div>
      </div>
    </div>

  </body>
</html>

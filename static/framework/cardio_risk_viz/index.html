<!DOCTYPE html>
<html>
  <head>
    <title>Cardiology Risk Visualization</title>
      <script src='../smart/scripts/smart-api-page.js'></script>
      <script src='../jquery/jquery.js'></script>
      <script src='./raphael-min.js'></script>
      <script src='./g.raphael.js'></script>
      <script>

      // improvments
      // - rm lines
      // - more semantic colors?
      // - bullet charts?

      // todo
      // - rdf
      // - plot circles on chart
      // - do risk score
      // - images



        // LAB_RESULTS_get
        // http://wiki.chip.org/smart-project/index.php/Developers_Documentation:_RDF_Data#Lab_Result_RDF
        //

        var reynolds_risks_score = function(p){
          // Reynolds Risk Score
          //
          // Women (not recommended for diabetics anymore? http://www.reynoldsriskscore.org/faq.aspx)
          // 10 year cardiovascular disease risk for women = 1-0.98634^(exp [B-22.325]) x 100%
          //
          // where B = 0.0799 x age 
          //         + 3.137 x ln(systolic bp)
          //         + 0.180 x ln(hsCRP)
          //         + 1.382 x ln(total cholesterol)
          //         - 1.172 x ln(HDL)
          //         + 0.134 x hba1c (%)  // if diabetic
          //         + 0.818              // if current smoker
          //         + 0.438              // if fx of premature myocardial infarction
          //
          // Men
          //
          // http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2752381/
          // 10 year cardiovascular disease risk for men = 1-0.8990^(exp [B-33.097]) x 100%
          //
          // where B = 4.385 x ln(age)
          //         + 2.607 x ln(systolic bp)
          //         + 0.102 x ln(hsCRP)
          //         + 0.963 x ln(total cholesterol)
          //         - 0.772 x ln(HDL)
          //         + 0.405              // if current smoker
          //         + 0.541              // if fx of premature myocardial infarction
          //
          // ** no hba1c! non-diabetic men
            
          var parameters = {}
            , result = null;

          if (p.gender.value === 'female') {
            params = {
              'age': 0.0799,
              'sbp': 3.137,
              'hsCRP': 0.180,
              'cholesterol': 1.382,
              'HDL': -1.172,
              'smoker': 0.818,
              'fx_of_mi': 0.438
            }
          } else {
            params = {
              'age': 4.385,
              'sbp': 2.607,
              'hsCRP': 0.102,
              'cholesterol': 0.963,
              'HDL': -0.772,
              'smoker': 0.405,
              'fx_of_mi': 0.541
            }
          }

          
          var b1 = params.age          * p.gender.value==='female' ? p.age.value : Math.log(p.age.value)
            , b2 = params.sbp          * Math.log(p.sbp.value)
            , b3 = params.hsCRP        * Math.log(p.hsCRP.value)
            , b4 = params.cholesterol  * Math.log(p.cholesterol.value)
            , b5 = params.HDL          * Math.log(p.HDL.value)
            , b6 = params.smoker       * p.smoker_p.value ? 1 : 0
            , b7 = params.fx_of_mi     * p.fx_of_mi_p.value ? 1 : 0;

          var B = b1 + b2 + b3 + b4 + b5 + b6 + b7;


          if (p.gender.value === 'female') {
            var a = Math.exp(B-22.325)
              , b = Math.pow(0.98634, a)
              , c = 1 - b
              , d = c * 100
              debugger;

            result = (1 - Math.pow(0.98634, (Math.exp(B-22.325)))) * 100
          } else {

            var a = Math.exp(B-33.097)
              , b = Math.pow(0.8990, a)
              , c = 1 - b
              , d = c * 100

            debugger;
              
            result = (1 - Math.pow(0.8990,  (Math.exp(B-33.097)))) * 100            
          }

          console.log('RRS %', result, 'B', B);
          return result;
        }

        SMART.DEMOGRAPHICS_get(function(demographics) {
          var p = demographics
            .prefix('foaf', 'http://xmlns.com/foaf/0.1/')
            .prefix('sp', 'http://smartplatforms.org/terms#')
            .where('?a foaf:givenName ?givenName')
            .where('?a foaf:familyName ?familyName')
            .where('?a foaf:gender ?gender')
            .where('?a sp:birthday ?birthday')
            .get(0);

          var get_age = function(dob_string){
            var dob = new Date(dob_string);
            var today = new Date();
            var db = new Date(dob_string);
            var cy = today.getFullYear();
            var by = dob.getFullYear();
            db.setFullYear(cy);
            var adj = (today-db<0) ? 1 : 0;
            return cy - by - adj;
          }

          p.age = {};
          p.age.value = get_age(p.birthday.value)

          SMART.LAB_RESULTS_get(function(labs){
            // fixturize until I figure out querying the rdf
            // fixturize until I figure out querying the rdf
            // fixturize until I figure out querying the rdf
            // fixturize until I figure out querying the rdf
            // fixturize until I figure out querying the rdf
            // fixturize until I figure out querying the rdf
            p.age.value = 49;
            p.gender.value = 'female';
            p.sbp = {'value': 130} // asssumed
            , p.hsCRP = {'value': 3.3}
            , p.cholesterol = {'value': 265}
            , p.LDL = {'value': 233}
            , p.HDL = {'value': 32}
            , p.smoker_p = {'value': true}
            , p.fx_of_mi_p = {'value': true};


            var score = reynolds_risks_score(p);

            // fixturize until I figure out querying the rdf
            // fixturize until I figure out querying the rdf

            var r = Raphael('holder');

            // set default txtattrs
            r.g.txtattr = {
              'font': '24px Calibri, \'Helvetica Neue\', Helvetica, Verdana, sans-serif', 
              'text-anchor': 'start',
              'fill': '#555'
            };

            // set up overall layout and text
            // using a 8 column grid on 800px
            r.g.text(0, 20, 'Bloodwork Cardiology Result')
            r.path("M0 40 L313 40").attr({'stroke-dasharray': '.', 'stroke-linecap': 'butt'})        

            // pad in 40px
            r.g.txtattr = {
              'font': '16px Calibri, \'Helvetica Neue\', Helvetica, Verdana, sans-serif', 
              'text-anchor': 'start',
              'fill': '#555'
            };
            r.g.text(40, 60+1, 'Patient info').attr({'font-size': '18px'})

            r.g.text(40, 80+1, 'NAME:').attr({'fill': '#888', 'font-size': '12px', 'font-weight': '200'});
            r.g.text(80, 80, p.givenName.value + ' ' + p.familyName.value).attr({'font-size': '18px'})
            
            r.g.text(40, 100+1, 'GENDER:').attr({'fill': '#888', 'font-size': '12px', 'font-weight': '200'});
            r.g.text(92, 100, p.gender.value == 'female' ? 'F' : 'M')
            
            r.g.text(112, 100+1, 'AGE:').attr({'fill': '#888', 'font-size': '12px', 'font-weight': '200'});
            r.g.text(142, 100, p.age.value)
            
            r.g.text(172, 100+1, 'DOB:').attr({'fill': '#888', 'font-size': '12px', 'font-weight': '200'});
            r.g.text(202, 100, p.birthday.value)

            r.path("M0 120 L800 120").attr({'stroke-dasharray': '.', 'stroke-linecap': 'butt'})        

            r.circle(40, 140, 14).attr({'fill': '#F4804E', 'stroke': 'none'});
            r.g.text(40, 140, '1').attr({'font': '18px Consolas', 'text-anchor': 'middle', 'font-weight': 'bold', 'fill': '#fff'})
            r.g.text(60, 140, 'About this test').attr({'font-size': '16px', 'font-weight': 'bold'})
            r.g.text(60, 160, 'This report evaluates your potential risk of heart disease, heart attack, and stroke.')
              .attr({'font-size': '14px'})
            
            r.path("M0 180 L800 180").attr({'stroke-dasharray': '.', 'stroke-linecap': 'butt'});

            r.circle(40, 200, 14).attr({'fill': '#F4804E', 'stroke': 'none'});
            r.g.text(40, 200, '2').attr({'font': '18px Consolas', 'text-anchor': 'middle', 'font-weight': 'bold', 'fill': '#fff'})
            r.g.text(60, 200, 'Your Results').attr({'font-size': '16px', 'font-weight': 'bold'})

            // first bar
            var title = 'CRP level test'
              , x = 60
              , y = 240
              , w = 700
              , h = 80
              , units_n = 10
              , unit_w = w / units_n
              , space = 2
              , cap_x = w + x
              , cap_y = y
              , cap_mid_x = 780
              , cap_mid_y = y + h/2
              , cap_end_x = cap_x
              , cap_end_y = y + h
            
            // make width smaller with space, start x on unit_w multiple 
            r.g.text(x, y-12, title).attr({'font-size': '14px', 'font-weight': 'bold'})

            r.rect(x+0,         y, unit_w-space,       h).attr({fill: '#61AFC9', stroke: 'none'});
            r.g.text(x, y+h+8, 'Low risk').attr({'font-size': '12px', 'font-weight': 'normal'})
            r.g.text(x, y+h+20, '0 mg/L').attr({'font-size': '10px', 'font-weight': '200', 'fill': '#888'})

            r.rect(x+unit_w,    y, unit_w*2-space,     h).attr({fill: '#008EB0', stroke: 'none'});
            r.g.text(x+unit_w,  y+h+8, 'Average').attr({'font-size': '12px', 'font-weight': 'normal'})
            r.g.text(x+unit_w,  y+h+20, '1 - 3').attr({'font-size': '10px', 'font-weight': '200', 'fill': '#888'})

            r.rect(x+unit_w*3,  y, unit_w*7,           h).attr({fill: '#0B9DBC', stroke: 'none'});
            r.g.text(x+unit_w*3, y+h+8, 'High risk of cardiovascular disease').attr({'font-size': '12px', 'font-weight': 'normal'})
            r.g.text(x+unit_w*3, y+h+20, '3 - 10 mg/L').attr({'font-size': '10px', 'font-weight': '200', 'fill': '#888'})

            r.path('M' + cap_x     + ' ' + cap_y + 
                   'L' + cap_mid_x + ' ' + cap_mid_y + 
                   'L' + cap_end_x + ' ' + cap_end_y +
                   'z')
                   .attr({'fill': '#0B9DBC', 'stroke': 'none'});

                   

            // var x = 60
            //   , y = 380
            //   , w = 700
            //   , h = 80
            //   , units_n = 10
            //   , unit_w = w / units_n
            //   , space = 2
            //   , cap_x = w + x
            //   , cap_y = y
            //   , cap_mid_x = 780
            //   , cap_mid_y = y + h/2
            //   , cap_end_x = cap_x
            //   , cap_end_y = y + h
            // 
            // // make width smaller with space, start x on unit_w multiple 
            // r.rect(x+0,         y, unit_w*6-space,  h).attr({fill: '#A0BE78', stroke: 'none'});
            // r.rect(x+unit_w*6,  y, unit_w*1-space,  h).attr({fill: '#86AD52', stroke: 'none'});
            // r.rect(x+unit_w*7,  y, unit_w*3,        h).attr({fill: '#5E892B', stroke: 'none'});
            // r.path('M' + cap_x     + ' ' + cap_y + 
            //        'L' + cap_mid_x + ' ' + cap_mid_y + 
            //        'L' + cap_end_x + ' ' + cap_end_y +
            //        'z')
            //        .attr({'fill': '#5E892B', 'stroke': 'none'});
          });
        });
    </script>
  </head>
  <body>
    <div id='holder' style='width: 800px; height: 600px;'></div>
    <div id='log'></div>
  </body>
</html>

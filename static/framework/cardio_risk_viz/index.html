<!DOCTYPE html>
<html>
  <head>
    <title>Cardiology Risk Visualization</title>
      <script src='../smart/scripts/smart-api-page.js'></script>
      <script src='../jquery/jquery.js'></script>
      <script src='./raphael-min.js'></script>
      <script src='./g.raphael.js'></script>
      <script src='./g.bar.js'></script>
      <script>
        // LAB_RESULTS_get
        // http://wiki.chip.org/smart-project/index.php/Developers_Documentation:_RDF_Data#Lab_Result_RDF


        // evelopment and Validation of Improved Algorithms for the Assessment of Global Cardiovascular Risk in Women
        //         PM Ridker, JE Buring, N Rifai… - JAMA, 2007
        // Model B, the Reynolds Risk Score
        // 10-year cardiovascular disease risk (%) =[1−0.98634
        // (exp[B−22.325])
        // ]100% where
        // B=0.0799  a g e  3.137  na tur a l  log a r i thm  ( s y s tol i c blood pr e s sur e ) 
        // 0.180natural logarithm (high-sensitivity C-reactive protein)  1.382natural
        // logarithm (total cholesterol) −1.172natural logarithm (high-density lipoprotein cholesterol)  0.134hemoglobin A1c
        // (%) (if diabetic)  0.818 (if current
        // smoker)  0.438 (if family history of premature myocardial infarction)
        
        
        // // detect resize events
        // $(window).resize(function() {
        //
        // USE http://raphaeljs.com/reference.html#setSize ? or scale?
        // 
        //   var iframe  = $(window.frameElement);
        //   console.log($(window).height(), $(window).width())
        //   console.log($(iframe).height(), $(iframe).width())
        //   $('#log').append('<div>Handler for .resize() called.</div>');
        // });


        //
        // MAIN
        //

        // // sizing: use 800x600 for now
        // // var iframe  = $(window.frameElement);
        // var h = 600; // $(iframe).height();
        // var w = 800; // $(iframe).width();
        // $('#holder').height(h);
        // $('#holder').width(w);

        SMART.DEMOGRAPHICS_get(function(demographics) {
          var p = demographics
            .prefix('foaf', 'http://xmlns.com/foaf/0.1/')
            .prefix('sp', 'http://smartplatforms.org/terms#')
            .where('?a foaf:givenName ?givenName')
            .where('?a foaf:familyName ?familyName')
            .where('?a foaf:gender ?gender')
            .where('?a sp:birthday ?birthday')
            .get(0);

          var get_age = function(dob_string){
            var dob = new Date(dob_string);
            var today = new Date();
            var db = new Date(dob_string);
            var cy = today.getFullYear();
            var by = dob.getFullYear();
            db.setFullYear(cy);
            var adj = (today-db<0) ? 1 : 0;
            return cy - by - adj;
          }

          p.age = {};
          p.age.value = get_age(p.birthday.value)

          SMART.LAB_RESULTS_get(function(labs){

            // fixturize until I figure out querying the rdf
            var crp = 3.3
              , total_cholesterol = 265
              , ldl_cholesterol = 233
              , hdl_cholesterol = 32;

            var r = Raphael('holder');

            // set default txtattrs
            r.g.txtattr = {
              'font': '24px \'Helvetica Neue\', Helvetica, Corbel, Verdana, sans-serif', 
              'text-anchor': 'start',
              'fill': '#555'
            };

            // set up overall layout and text
            // using a 8 column grid on 800px
            r.g.text(0, 20, 'Bloodwork Cardiology Result')
            r.path("M0 40 L313 40").attr({'stroke-dasharray': '.', 'stroke-linecap': 'butt'})        

            // pad in 40px
            r.g.txtattr = {
              'font': '16px \'Helvetica Neue\', Helvetica, Corbel, Verdana, sans-serif', 
              'text-anchor': 'start',
              'fill': '#555'
            };
            r.g.text(40, 60+1, 'NAME:').attr({'fill': '#888', 'font-size': '12px', 'font-weight': '200'});
            r.g.text(80, 60, p.givenName.value + ' ' + p.familyName.value).attr({'font-size': '18px'})
            
            r.g.text(40, 80+1, 'GENDER:').attr({'fill': '#888', 'font-size': '12px', 'font-weight': '200'});
            r.g.text(92, 80, p.gender.value == 'female' ? 'F' : 'M')
            
            r.g.text(112, 80+1, 'AGE:').attr({'fill': '#888', 'font-size': '12px', 'font-weight': '200'});
            r.g.text(142, 80, p.age.value)
            
            r.g.text(172, 80+1, 'DOB:').attr({'fill': '#888', 'font-size': '12px', 'font-weight': '200'});
            r.g.text(202, 80, p.birthday.value)

            r.path("M0 100 L800 100").attr({'stroke-dasharray': '.', 'stroke-linecap': 'butt'})        

            r.circle(40, 120, 14).attr({'fill': '#F4804E', 'stroke': 'none'});
            r.g.text(40, 120, '1').attr({'font-size': '18px', 'text-anchor': 'middle', 'font-weight': 'bold', 'fill': '#fff'})
            r.g.text(60, 120, 'About this test').attr({'font-size': '16px', 'font-weight': 'bold'})
            r.g.text(60, 140, 'This report evaluates your potential risk of heart disease, heart attack, and stroke.')
              .attr({'font-size': '14px'})
            
            r.path("M0 160 L800 160").attr({'stroke-dasharray': '.', 'stroke-linecap': 'butt'});

            r.circle(40, 180, 14).attr({'fill': '#F4804E', 'stroke': 'none'});
            r.g.text(40, 180, '2').attr({'font-size': '18px', 'text-anchor': 'middle', 'font-weight': 'bold', 'fill': '#fff'})
            r.g.text(60, 180, 'Your Results').attr({'font-size': '16px', 'font-weight': 'bold'})

            // first bar
            var x = 60
              , y = 220
              , w = 700
              , h = 80
              , units_n = 10
              , unit_w = w / units_n
              , space = 2
              , cap_x = w + x
              , cap_y = y
              , cap_mid_x = 780
              , cap_mid_y = y + h/2
              , cap_end_x = cap_x
              , cap_end_y = y + h
            
            // make width smaller with space, start x on unit_w multiple 
            r.rect(x+0,         y, unit_w-space,       h).attr({fill: '#61AFC9', stroke: 'none'});
            r.rect(x+unit_w,    y, unit_w*2-space,     h).attr({fill: '#008EB0', stroke: 'none'});
            r.rect(x+unit_w*3,  y, unit_w*7,           h).attr({fill: '#0B9DBC', stroke: 'none'});
            r.path('M' + cap_x     + ' ' + cap_y + 
                   'L' + cap_mid_x + ' ' + cap_mid_y + 
                   'L' + cap_end_x + ' ' + cap_end_y +
                   'z')
                   .attr({'fill': '#0B9DBC', 'stroke': 'none'});

            var x = 60
              , y = 360
              , w = 700
              , h = 80
              , units_n = 10
              , unit_w = w / units_n
              , space = 2
              , cap_x = w + x
              , cap_y = y
              , cap_mid_x = 780
              , cap_mid_y = y + h/2
              , cap_end_x = cap_x
              , cap_end_y = y + h
            
            // make width smaller with space, start x on unit_w multiple 
            r.rect(x+0,         y, unit_w*6-space,  h).attr({fill: '#A0BE78', stroke: 'none'});
            r.rect(x+unit_w*6,  y, unit_w*1-space,  h).attr({fill: '#86AD52', stroke: 'none'});
            r.rect(x+unit_w*7,  y, unit_w*3,        h).attr({fill: '#5E892B', stroke: 'none'});
            r.path('M' + cap_x     + ' ' + cap_y + 
                   'L' + cap_mid_x + ' ' + cap_mid_y + 
                   'L' + cap_end_x + ' ' + cap_end_y +
                   'z')
                   .attr({'fill': '#5E892B', 'stroke': 'none'});
          });
        });
    </script>
  </head>
  <body>
    <div id='holder' style='width: 800px; height: 600px;'></div>
    <div id='log'></div>
  </body>
</html>

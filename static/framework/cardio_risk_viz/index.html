<!DOCTYPE html>
<html>
  <head>
    <title>Cardiology Risk Visualization</title>
      <script src='../smart/scripts/smart-api-page.js'></script>
      <script src='../jquery/jquery.js'></script>
      <script src='./raphael-min.js'></script>
      <script src='./g.raphael.js'></script>
      <script src='./g.bar.js'></script>
      <script>
        // LAB_RESULTS_get
        // http://wiki.chip.org/smart-project/index.php/Developers_Documentation:_RDF_Data#Lab_Result_RDF


        // evelopment and Validation of Improved Algorithms for the Assessment of Global Cardiovascular Risk in Women
        //         PM Ridker, JE Buring, N Rifai… - JAMA, 2007
        // Model B, the Reynolds Risk Score
        // 10-year cardiovascular disease risk (%) =[1−0.98634
        // (exp[B−22.325])
        // ]100% where
        // B=0.0799  a g e  3.137  na tur a l  log a r i thm  ( s y s tol i c blood pr e s sur e ) 
        // 0.180natural logarithm (high-sensitivity C-reactive protein)  1.382natural
        // logarithm (total cholesterol) −1.172natural logarithm (high-density lipoprotein cholesterol)  0.134hemoglobin A1c
        // (%) (if diabetic)  0.818 (if current
        // smoker)  0.438 (if family history of premature myocardial infarction)
        
        
        // // detect resize events
        // $(window).resize(function() {
        //
        // USE http://raphaeljs.com/reference.html#setSize ? or scale?
        // 
        //   var iframe  = $(window.frameElement);
        //   console.log($(window).height(), $(window).width())
        //   console.log($(iframe).height(), $(iframe).width())
        //   $('#log').append('<div>Handler for .resize() called.</div>');
        // });


        //
        // MAIN
        //

        // sizing: use 800x600 for now
        // var iframe  = $(window.frameElement);
        var h = 600; // $(iframe).height();
        var w = 800; // $(iframe).width();
        $('#holder').height(h);
        $('#holder').width(w);

        SMART.DEMOGRAPHICS_get(function(demographics) {
          var p = demographics
            .prefix('foaf', 'http://xmlns.com/foaf/0.1/')
            .prefix('sp', 'http://smartplatforms.org/terms#')
            .where('?a foaf:givenName ?givenName')
            .where('?a foaf:familyName ?familyName')
            .where('?a foaf:gender ?gender')
            .where('?a sp:birthday ?birthday')
            .get(0);

          var get_age = function(dob_string){
            var dob = new Date(dob_string);
            var today = new Date();
            var db = new Date(dob_string);
            var cy = today.getFullYear();
            var by = dob.getFullYear();
            db.setFullYear(cy);
            var adj = (today-db<0) ? 1 : 0;
            return cy - by - adj;
          }

          p.age = {};
          p.age.value = get_age(p.birthday.value)

          SMART.LAB_RESULTS_get(function(labs){

            // fixturize until I figure out querying the rdf
            var crp = 3.3
              , total_cholesterol = 265
              , ldl_cholesterol = 233
              , hdl_cholesterol = 32;

            // some ranges
            var r = Raphael('holder'),
              fin2 = function () {
                var y = [], res = [];
                for (var i = this.bars.length; i--;) {
                  y.push(this.bars[i].y);
                  res.push(this.bars[i].value || '0');
                }
                this.flag = r.g.popup(this.bars[0].x, Math.min.apply(Math, y), res.join(', ')).insertBefore(this);
              },
              fout2 = function () {
                this.flag.animate({opacity: 0}, 300, function () {this.remove();});
              };

            // set default txtattrs
            r.g.txtattr = {
              'font': '24px \'Helvetica Neue\', Helvetica, Corbel, Verdana, sans-serif', 
              'text-anchor': 'start'
            };

            // set up overall layout and text
            r.g.text(0, 20, 'Bloodwork Cardiology Result').attr({'fill': '#555'});

            // metadata
            r.g.txtattr = {'font-size': '12px', 'font-weight': 'bold'};
            r.g.text(400, 10, 'ORDERED BY').attr({'fill': '#555'});
            r.g.txtattr = {'font-size': '12px', 'font-weight': 'bold'};
            r.g.text(400, 25, p.givenName.value).attr({'fill': '#555'});

            // var v = r.g.hbarchart(
            //   0,
            //   50,
            //   700,
            //   150,
            //   [
            //     [2],
            //     [3],
            //     [7]
            //   ],
            //   {
            //     stacked: true,
            //     type: 'sharp',
            //     colors: ['#61AFC9', '#008EB0', '#0B9DBC']
            //   }
            // );

            // first bar
            var w = 800
              , h = 50
              , units_n = 10
              , unit_w = w / units_n
              , x = 0
              , y = 150
              , space = 2
              , cap_w = 35.35; // h^(1/2) / 2
            
            // make width smaller with space, start x on unit_w multiple 
            r.rect(0,         y, unit_w-space,       h).attr({fill: '#61AFC9', stroke: 'none'});
            r.rect(unit_w,    y, unit_w*2-space,     h).attr({fill: '#008EB0', stroke: 'none'});
            r.rect(unit_w*3,  y, unit_w*7-(cap_w/2), h).attr({fill: '#0B9DBC', stroke: 'none'});
            r.rect(w-cap_w/2, y, cap_w,              cap_w).attr({fill: '#0B9DBC', stroke: 'none'}).rotate(45, w-cap_w/2, y);
            
            // second bar
            var w = 800
              , h = 50
              , unit_w = 26.66
              , x = 0
              , y = 250
              , space = 2
              , cap_w = 35.35;
            
            r.rect(0,            y, unit_w*20-space,       h).attr({fill: '#A0BE78', stroke: 'none'});
            r.rect(unit_w*20,    y, unit_w*3-space,     h).attr({fill: '#86AD52', stroke: 'none'});
            r.rect(unit_w*23,    y, unit_w*7-(cap_w/2), h).attr({fill: '#5E892B', stroke: 'none'});
            r.rect(w-cap_w/2, y, cap_w,              cap_w).attr({fill: '#5E892B', stroke: 'none'}).rotate(45, w-cap_w/2, y);


          });
        });
    </script>
  </head>
  <body>
    <div id='holder' style=''></div>
    <div id='log'></div>
  </body>
</html>

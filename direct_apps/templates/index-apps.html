<!DOCTYPE html>
<html>
<head>
   <link rel="stylesheet" href="/static/css/main.css" type="text/css" media="screen" />
   <link rel="stylesheet" href="/static/themes/redmond/jquery.ui.all.css" type="text/css" media="screen" />
   <script src="/static/smart/smart-api-client.js"></script>
   <script src="/static/lib/jquery-1.6.2.js"></script>
   <script src="/static/lib/jquery-ui-1.8.14.custom.min.js" type="text/javascript"></script>
   <script src="/static/lib/json2.js"></script>
   <script type="text/javascript" src="/static/ckeditor/ckeditor.js"></script>
   <script src="/static/js/load_data.js"></script>
</head>
<body>

<h3>Send SMART Apps</h3>

<div id='main-panel'>   
<table>
   <tr>
      <td valign="top" align="right">
          <label for="address">To: </label>
      </td>
      <td>
          <input id="address" size="50" />
      </td>
   </tr>
   <tr>
      <td valign="top" align="right">
          <label for="subject">Subject: </label>
      </td>
      <td>
           <input type="text" id="subject" size="50" />
      </td>
   </tr>
   <tr>
      <td valign="top" align="right">
        <label for="notes">Notes: </label><br/>
      </td>
      <td>
        <textarea id='notes' name='notes' cols='80' rows='5'></textarea>
        <script type="text/javascript">
            DIRECT.loadCK = function () {
                CKEDITOR.replace( 'notes',
                    {
                        removePlugins: 'elementspath',
                        toolbar :
                        [
                            { name: 'clipboard', items : [ 'Cut','Copy','Paste','PasteText','PasteFromWord','-','Undo','Redo' ] },
                            { name: 'editing', items : [ 'Find','Replace','-','SelectAll','-','SpellChecker', 'Scayt' ] },
                            { name: 'basicstyles', items : [ 'Bold','Italic','Underline','Strike','Subscript','Superscript','-','RemoveFormat' ] },
                            '/',
                            { name: 'paragraph', items : [ 'NumberedList','BulletedList','-','Outdent','Indent','-','Blockquote','CreateDiv','-','JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock','-','BidiLtr','BidiRtl' ] },
                            { name: 'links', items : [ 'Link','Unlink','Anchor' ] },
                            { name: 'insert', items : [ 'Image','Table','HorizontalRule','SpecialChar','PageBreak' ] },
                            '/',
                            { name: 'styles', items : [ 'Styles','Format','Font','FontSize' ] },
                            { name: 'colors', items : [ 'TextColor','BGColor' ] }
                        ]
                    });
            };
        </script>
        
      </td>
   </tr>
   <tr>
      <td valign="top" align="right">
            <label for="apps">Apps: </label><br/>
      </td>
      <td>
        <div id="apps">
        </div>
      </td>
   </tr>
</table>

<p><input id='send_apps' type='button' value='Send' /></p>

</div>

<div id="spinner">
    <img src='/static/images/ajax-loader.gif' />
</div>

<div id="dialog-message" title="Info">
    <p>Message successfully sent</p>
</div>
    
<script>    
$.ajaxSetup ({cache: false});

$('#send_apps').button();
$('#send_apps').click(function(){
    var app_checked = false,
        myapps = [];

    if ($('#address').val().length === 0) { 
        alert ("Please enter the recipient's direct address");
        return;
    } else {
        email = $('#address').val().split("@");
        if (email.length !== 2) {
            alert ("Please enter a valid address");
            return;
        }
    }
    
    if ($('#subject').val().length === 0) { 
        alert ("Please enter a subject");
        return;
    }
    
    for (var i = 0; i < DIRECT.apps["apps"].length; i++) {
        if ($('#app-' + i).attr('checked')) {
            app_checked = true;
            myapps.push(DIRECT.apps["apps"][i]["id"]);
        }
    }
    
    if (!app_checked) { 
        alert ("Please select apps");
        return;
    }
    
    $('#send_apps').button('disable');
    $('#spinner').show();
    
    $.post(  
        "sendmail-apps",  
        {'sender_name': DIRECT.sender.name,
         'sender_email': DIRECT.sender.email,
         'recipient_email': $('#address').val(),
         'subject': '[SMART_APP]' + $('#subject').val(),
         'message': CKEDITOR.instances.notes.getData(),
         'apps': myapps.toString(),
         'oauth_header': SMART.credentials.oauth_header},  
        function(responseText){
            $('#send_apps').button('enable');
            $('#spinner').hide();
            $( "#dialog-message" ).dialog({
                modal: true,
                buttons: {
                    Ok: function() {
                        $(this).dialog("close");
                    }
                }
            });
        },  
        "html"  
    );
});

SMART.ready(function() {
    $.when(DIRECT.loadDemographics(), DIRECT.loadUser(), 
           DIRECT.loadRecepients(), DIRECT.loadApps()).then(function() {
        $('#subject').val(DIRECT.sender.name + " has shared SMART apps with you");
        $('#notes').val("Explore " + DIRECT.patient.firstname + " " + DIRECT.patient.lastname + "'s record with these SMART apps.");
        DIRECT.loadCK();
        $('#spinner').hide();
        $('#main-panel').show();
    });
});
    
</script>
</body>
</html>